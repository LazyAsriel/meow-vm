# File: tests/call_bench.meow

.func @add_recursive
    .registers 4
    # Khai báo hằng số tên biến global cần truy cập
    .const "add_recursive"  # Index 0

    # R0: n, R1: acc
    # R2: temp (n-1), R3: temp (acc+n)

    # Điều kiện dừng: n < 1
    LOAD_INT 2, 1
    LT 2, 0, 2          
    JUMP_IF_TRUE 2, stop

    # Đệ quy: add_recursive(n - 1, acc + n)
    
    # 1. Tính n - 1 vào R2
    LOAD_INT 2, 1
    SUB 2, 0, 2         
    
    # 2. Tính acc + n vào R3
    ADD 3, 1, 0         
    
    # Lấy hàm add_recursive từ Global (dùng hằng số index 0)
    GET_GLOBAL 0, 0 
    
    # Gọi hàm: CALL dst, fn, arg_start, argc
    CALL 0, 0, 2, 2     
    
    RETURN 0

stop:
    RETURN 1
.endfunc

.func @main
    .registers 4
    
    # --- KHAI BÁO HẰNG SỐ ---
    .const @add_recursive   # Index 0: Proto cho CLOSURE
    .const "add_recursive"  # Index 1: Tên biến cho SET_GLOBAL
    .const "print"          # Index 2: Tên hàm print
    
    # Tạo closure từ proto tại index 0
    CLOSURE 0, 0
    
    # Gán vào biến global "add_recursive" (tên tại index 1)
    SET_GLOBAL 1, 0

    # Setup: n=1000 (R1), acc=0 (R2)
    LOAD_INT 1, 1000    
    LOAD_INT 2, 0       
    
    # Lấy lại hàm từ global để gọi (dùng tên tại index 1)
    GET_GLOBAL 0, 1
    
    # Gọi add_recursive(n, acc) -> Kết quả vào R3
    CALL 3, 0, 1, 2     
    
    # Lấy hàm print (tên tại index 2)
    GET_GLOBAL 0, 2
    
    # print(R3)
    CALL_VOID 0, 3, 1
    
    HALT
.endfunc