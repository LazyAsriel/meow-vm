.func @recursive_sum
    .registers 4
    .const "recursive_sum"  # [FIX] Index 0 cho GET_GLOBAL

    # if n < 1 return acc
    LOAD_INT 2, 1
    LT 2, 0, 2
    JUMP_IF_TRUE 2, stop

    # n - 1
    LOAD_INT 2, 1
    SUB 2, 0, 2
    
    # acc + 1
    LOAD_INT 3, 1
    ADD 3, 1, 3

    # Lấy hàm đệ quy (recursive_sum) từ Global vào R0
    GET_GLOBAL 0, 0

    # Tối ưu đuôi (Tail Call Optimization)
    TAIL_CALL 0, 0, 2, 2

stop:
    RETURN 1
.endfunc

.func @main
    .registers 5
    .const "recursive_sum"
    .const @recursive_sum
    .const "print"

    # 1. Đăng ký hàm vào Global
    CLOSURE 0, 1
    SET_GLOBAL 0, 0

    # 2. Gọi hàm với n = 10,000,000
    LOAD_INT 1, 100  # n
    LOAD_INT 2, 0         # acc
    
    GET_GLOBAL 0, 0
    CALL 3, 0, 1, 2       # Gọi lần đầu vẫn là CALL thường

    # 3. In kết quả (Mong đợi: 100)
    GET_GLOBAL 4, 2
    CALL_VOID 4, 3, 1
    
    HALT
.endfunc